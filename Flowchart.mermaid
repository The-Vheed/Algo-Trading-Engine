graph TB
    %% External Systems
    subgraph "External Data Sources"
        OANDA[OANDA API]
        IB[Interactive Brokers]
        OTHER[Other Brokers]
        CSV[CSV Files]
        DB_HIST[Historical DB]
    end
    
    %% Enhanced Core Services
    subgraph "Core Trading System"
        
        subgraph "Enhanced Data Service"
            DS[Data Service<br/>Mode-Aware Data Management]
            BC[Broker Connector<br/>Live WebSocket & REST]
            BTC[Backtest Connector<br/>Historical Data Replay]
            PTC[Paper Trading Connector<br/>Simulated Live Feed]
            DP[Data Processor<br/>Validation & Normalization]
        end
        
        subgraph "Analysis Service"
            AS[Analysis Service<br/>Technical Analysis Hub]
            IE[Indicator Engine<br/>ADX, EMA, MACD, Stochastic, ATR]
            PD[Pattern Detector<br/>Candlesticks & S/R]
            PM[Plugin Manager<br/>FVG, Order Flow, Custom]
        end
        
        subgraph "Enhanced Strategy Service"
            SS[Strategy Service<br/>Mode-Aware Trading Logic]
            RD[Regime Detector<br/>ADX + Volatility Filter]
            SG[Signal Generator<br/>Trending/Ranging/Neutral]
            RM[Risk Manager<br/>Position Sizing & SL/TP]
            LTE[Live Trade Executor<br/>Real Order Management]
            BTE[Backtest Executor<br/>Synthetic Trade Execution]
            PTE[Paper Trade Executor<br/>Simulated Orders]
        end
        
        subgraph "New Backtesting Service"
            BS[Backtesting Service<br/>Historical Testing Engine]
            BE[Backtest Engine<br/>Main Orchestrator]
            PA[Performance Analyzer<br/>Sharpe, Calmar, Drawdown]
            RG[Report Generator<br/>HTML/PDF Reports]
            PO[Parameter Optimizer<br/>Grid/Random Search]
        end
        
        subgraph "Enhanced Monitoring Service"
            MS[Monitoring Service<br/>System Health & Performance]
            MC[Metrics Collector<br/>Prometheus]
            LOG[Structured Logging]
            ALERT[Alert Manager<br/>Notifications]
            BR[Backtest Reporter<br/>Result Visualization]
        end
    end
    
    %% Storage Layer
    subgraph "Storage Layer"
        REDIS[(Redis<br/>Cache & Pub/Sub)]
        POSTGRES[(PostgreSQL<br/>All Data & Results)]
        FILES[(File System<br/>Reports & Logs)]
    end
    
    %% Plugin Ecosystem
    subgraph "Plugin Ecosystem"
        FVG[Fair Value Gap<br/>Plugin]
        OF[Order Flow<br/>Plugin]
        CUSTOM[Custom Indicator<br/>Plugin]
    end
    
    %% Configuration & Deployment
    subgraph "Configuration & Control"
        CONFIG[YAML Configuration<br/>Mode & Parameters]
        ENV[Environment Variables<br/>Secrets & Settings]
        CLI[CLI Interface<br/>Backtesting Commands]
    end
    
    %% Main Application with Mode Selection
    subgraph "Application Layer"
        MAIN[Main Trading System<br/>Mode-Aware Orchestrator]
        LIVE_MODE[Live Trading Mode<br/>Real-time Processing]
        BT_MODE[Backtesting Mode<br/>Historical Replay]
        PAPER_MODE[Paper Trading Mode<br/>Simulated Real-time]
    end
    
    %% Data Source Connections
    OANDA --> BC
    IB --> BC
    OTHER --> BC
    CSV --> BTC
    DB_HIST --> BTC
    OANDA -.-> PTC
    IB -.-> PTC
    
    %% Data Service Internal Connections
    BC --> DP
    BTC --> DP
    PTC --> DP
    DP --> DS
    DS --> REDIS
    DS --> POSTGRES
    
    %% Analysis Service Connections
    DS --> AS
    AS --> IE
    AS --> PD
    AS --> PM
    PM --> FVG
    PM --> OF  
    PM --> CUSTOM
    
    %% Strategy Service Connections
    AS --> SS
    SS --> RD
    SS --> SG
    SS --> RM
    
    %% Mode-Specific Executor Connections
    RM --> LTE
    RM --> BTE
    RM --> PTE
    
    %% Backtesting Service Connections
    SS -.-> BS
    BS --> BE
    BS --> PA
    BS --> RG
    BS --> PO
    BE --> BTE
    
    %% Execution Results
    LTE --> POSTGRES
    BTE --> POSTGRES
    PTE --> POSTGRES
    
    %% Monitoring Connections
    SS --> MS
    BS --> MS
    MS --> MC
    MS --> LOG
    MS --> ALERT
    MS --> BR
    
    %% Report Generation
    PA --> RG
    RG --> FILES
    BR --> FILES
    
    %% Configuration Flow
    CONFIG --> MAIN
    ENV --> MAIN
    CLI --> MAIN
    
    %% Main Application Mode Control
    MAIN --> LIVE_MODE
    MAIN --> BT_MODE
    MAIN --> PAPER_MODE
    
    %% Mode-Specific Service Initialization
    LIVE_MODE --> DS
    LIVE_MODE --> AS
    LIVE_MODE --> SS
    LIVE_MODE --> MS
    
    BT_MODE --> DS
    BT_MODE --> AS
    BT_MODE --> SS
    BT_MODE --> BS
    BT_MODE --> MS
    
    PAPER_MODE --> DS
    PAPER_MODE --> AS
    PAPER_MODE --> SS
    PAPER_MODE --> MS
    
    %% Cache and Database Connections
    REDIS -.-> AS
    REDIS -.-> SS
    REDIS -.-> BS
    POSTGRES -.-> AS
    POSTGRES -.-> SS
    POSTGRES -.-> BS
    POSTGRES -.-> PA
    
    %% Styling
    classDef external fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef service fill:#e8f5e8,stroke:#1b5e20,stroke-width:3px
    classDef backtest fill:#fff8e1,stroke:#ff8f00,stroke-width:3px
    classDef storage fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef plugin fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef config fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    classDef main fill:#ffebee,stroke:#b71c1c,stroke-width:3px
    classDef mode fill:#e3f2fd,stroke:#0d47a1,stroke-width:2px
    
    class OANDA,IB,OTHER,CSV,DB_HIST external
    class DS,AS,SS,MS service
    class BS,BE,PA,RG,PO,BR backtest
    class REDIS,POSTGRES,FILES storage
    class FVG,OF,CUSTOM plugin
    class CONFIG,ENV,CLI config
    class MAIN main
    class LIVE_MODE,BT_MODE,PAPER_MODE mode